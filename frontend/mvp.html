<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Drone Detection Dashboard – Real‑Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />

  <style>
    /* ========= CARD STYLING ========= */
    .sensor-card{background:#f8f9fa;border:1px solid #ced4da;border-radius:.5rem;padding:1rem;margin-bottom:1rem;border-left:6px solid gray;}
    .sensor-card.online{border-left-color:#28a745;}
    .sensor-card.offline{border-left-color:#dc3545;}

    /* ========= TABLE ========= */
    .table-responsive{max-height:60vh;overflow-y:auto;}

    /* ========= MAP ========= */
    #radarMap{height:500px;border:1px solid #ced4da;border-radius:.5rem;}
  </style>
</head>
<body class="p-4 bg-light">
  <div class="container-xl">
    <h1 class="mb-4">Drone Detection Dashboard – Real‑Time</h1>

    <!-- SENSOR STATUS GRID -->
    <div id="sensorGrid" class="row gy-4 mb-5"></div>

    <!-- RADAR VIEW -->
    <h2 class="mt-5 mb-3">Live Radar View</h2>
    <div id="radarMap"></div>

    <!-- DETECTION TABLE -->
    <h2 class="mb-3">Live Drone Detections</h2>
    <div class="table-responsive">
      <table id="detectionTable" class="table table-striped table-sm align-middle">
        <thead class="table-dark position-sticky top-0">
          <tr>
            <th>Time&nbsp;(local)</th>
            <th>Sensor&nbsp;ID</th>
            <th>Location</th>
            <th>RSSI&nbsp;(dBm)</th>
            <th>Freq&nbsp;(GHz)</th>
            <th>Confidence</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- JS libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /* ========= CONFIG ========= */
    const REFRESH_MS = 500;              // update speed for mock feed
    // const WS_URL = "wss://your‑real‑endpoint"; // uncomment when ready

    /* ========= TIME HELPER ========= */
    const fmtTime = d => {
      const ms = String(d.getMilliseconds()).padStart(3,'0');
      return d.toLocaleTimeString([], {hour12:false}) + '.' + ms;
    };

    /* ========= SENSOR DEFINITIONS ========= */
    const sensors=[{
      id:"sensor-001",
      location:"Syracuse HQ Roof",
      lat:43.0481,
      lon:-76.1474,
      signalStrength:82,
      lastSeen:new Date().toISOString(),
      status:"online"
    }];

    /* ========= DRONE STATE ========= */
    const rand=(min,max)=>Math.random()*(max-min)+min;
    let dronePos={lat:sensors[0].lat+rand(-0.02,0.02), lon:sensors[0].lon+rand(-0.02,0.02)};
    let pathCoords=[];
    let droneMarker=null;
    let polyline=null;

    /* ========= MOCK DATA ========= */
    const mockDetection = () => {
      dronePos.lat += rand(-0.00035,0.00035);
      dronePos.lon += rand(-0.00035,0.00035);
      const s = sensors[0];
      return {
        detectedAt: new Date().toISOString(),
        sensorId: s.id,
        location: s.location,
        lat: dronePos.lat,
        lon: dronePos.lon,
        rssi: Math.round(rand(-95,-35)),
        freq: rand(2.4,5.9).toFixed(2),
        confidence: rand(0.6,0.97).toFixed(2)
      };
    };

    /* ========= UI RENDERING ========= */
    const sensorGrid = document.getElementById('sensorGrid');
    const renderSensors = () => {
      sensorGrid.innerHTML='';
      sensors.forEach(s=>{
        sensorGrid.insertAdjacentHTML('beforeend',`
          <div class="col-12 col-md-6 col-lg-4">
            <div class="sensor-card ${s.status}">
              <h5 class="mb-1">${s.location}</h5>
              <p class="mb-1"><strong>ID:</strong> ${s.id}</p>
              <p class="mb-1"><strong>Signal:</strong> ${s.signalStrength}%</p>
              <p class="mb-1"><strong>Last&nbsp;Seen:</strong> ${fmtTime(new Date(s.lastSeen))}</p>
              <p class="mb-0"><strong>Status:</strong> <span class="text-${s.status==='online'?'success':'danger'}">${s.status}</span></p>
            </div>
          </div>`);
      });
    };

    const tableBody = document.querySelector('#detectionTable tbody');
    const prependRow = det => {
      const row=document.createElement('tr');
      row.innerHTML=`<td>${fmtTime(new Date(det.detectedAt))}</td>
        <td>${det.sensorId}</td>
        <td>${det.location}</td>
        <td>${det.rssi}</td>
        <td>${det.freq}</td>
        <td>${(det.confidence*100).toFixed(0)}%</td>`;
      tableBody.prepend(row);
      if(tableBody.rows.length>200) tableBody.deleteRow(-1);
    };

    /* ========= MAP ========= */
    const map = L.map('radarMap').setView([sensors[0].lat,sensors[0].lon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    // sensor markers only (no coverage rings)
    sensors.forEach(s => {
      L.circleMarker([s.lat,s.lon], {radius:10,color:'#0d6efd',fill:true,fillColor:'#0d6efd',fillOpacity:1})
        .addTo(map).bindPopup(`${s.location} (Sensor)`);
    });

    const updateDroneOnMap = (lat,lon) => {
      if(!droneMarker){
        droneMarker = L.circleMarker([lat,lon], {radius:7,color:'#dc3545',fillColor:'#dc3545',fillOpacity:0.85}).addTo(map).bindPopup('Tracked Drone');
      } else {
        droneMarker.setLatLng([lat,lon]);
      }

      pathCoords.push([lat,lon]);
      if(!polyline){
        polyline = L.polyline(pathCoords, {color:'#dc3545',weight:2}).addTo(map);
      } else {
        polyline.setLatLngs(pathCoords);
      }
      // we keep the camera fixed; no auto fitBounds or arrows
    };

    /* ========= UPDATE HANDLER ========= */
    const handleDetection = det => {
      prependRow(det);
      updateDroneOnMap(det.lat,det.lon);

      const s = sensors.find(x=>x.id===det.sensorId) || sensors[0];
      s.lastSeen = det.detectedAt;
      s.signalStrength = Math.min(100, Math.max(0, s.signalStrength + Math.round(rand(-2,2))));
      renderSensors();
    };

    // mock interval (still active until WS impl)
    setInterval(()=>handleDetection(mockDetection()), REFRESH_MS);

    /* ========= INIT ========= */
    renderSensors();
    updateDroneOnMap(dronePos.lat, dronePos.lon);
  </script>
</body>
</html>
