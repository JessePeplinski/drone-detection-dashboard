<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Drone Detection Dashboard – MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Leaflet CSS for map -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />

  <style>
    /* ========= CARD STYLING ========= */
    .sensor-card {background:#f8f9fa;border:1px solid #ced4da;border-radius:.5rem;padding:1rem;margin-bottom:1rem;border-left:6px solid gray;}
    .sensor-card.online  {border-left-color:#28a745;}     /* green  */
    .sensor-card.offline {border-left-color:#dc3545;}     /* red    */

    /* ========= TABLE ========= */
    .table-responsive {max-height:60vh;overflow-y:auto;}

    /* ========= RADAR MAP ========= */
    #radarMap {height:400px;border:1px solid #ced4da;border-radius:.5rem;}
  </style>
</head>
<body class="p-4 bg-light">
  <div class="container-xl">
    <h1 class="mb-4">Drone Detection Dashboard – MVP</h1>

    <!-- SENSOR STATUS GRID -->
    <div id="sensorGrid" class="row gy-4 mb-5"></div>

    <!-- DETECTION TABLE -->
    <h2 class="mb-3">Live Drone Detections</h2>
    <div class="table-responsive">
      <table id="detectionTable" class="table table-striped table-sm align-middle">
        <thead class="table-dark position-sticky top-0">
          <tr>
            <th>Time&nbsp;(local)</th>
            <th>Sensor&nbsp;ID</th>
            <th>Location</th>
            <th>RSSI&nbsp;(dBm)</th>
            <th>Freq&nbsp;(GHz)</th>
            <th>Confidence</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- RADAR MAP -->
    <h2 class="mt-5 mb-3">Radar View</h2>
    <div id="radarMap"></div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /* ========= MOCK SENSOR DEFINITIONS ========= */
    const sensors = [
      {
        id: "sensor-001",
        location: "Syracuse HQ Roof",
        lat: 43.0481,         // base position for the Pi
        lon: -76.1474,
        signalStrength: 82,
        lastSeen: new Date().toISOString(),
        status: "online"
      }
    ];

    /* ========= HELPER FUNCTIONS ========= */
    const rand = (min, max) => Math.random() * (max - min) + min;
    function ago(sec){return new Date(Date.now()-sec*1000).toISOString();}

    function mockDetection(){
      const base = sensors[0];
      return {
        detectedAt: new Date().toISOString(),
        sensorId: base.id,
        location: base.location,
        lat: base.lat + rand(-0.02,0.02),   // ~2‑3 km radius
        lon: base.lon + rand(-0.02,0.02),
        rssi: Math.round(rand(-95,-35)),
        freq: rand(2.4,5.9).toFixed(2),
        confidence: rand(0.6,0.97).toFixed(2)
      };
    }

    /* ========= RENDER SENSOR CARDS ========= */
    const grid = document.getElementById("sensorGrid");
    function renderSensors(){
      grid.innerHTML="";
      sensors.forEach(s=>{
        const col=document.createElement("div");
        col.className="col-12 col-md-6 col-lg-4";
        col.innerHTML=`<div class="sensor-card ${s.status}">
          <h5 class="mb-1">${s.location}</h5>
          <p class="mb-1"><strong>ID:</strong> ${s.id}</p>
          <p class="mb-1"><strong>Signal:</strong> ${s.signalStrength}%</p>
          <p class="mb-1"><strong>Last&nbsp;Seen:</strong> ${new Date(s.lastSeen).toLocaleString()}</p>
          <p class="mb-0"><strong>Status:</strong> <span class="text-${s.status==='online'?'success':'danger'}">${s.status}</span></p>
        </div>`;
        grid.appendChild(col);
      });
    }

    /* ========= TABLE RENDER ========= */
    const tableBody = document.querySelector("#detectionTable tbody");
    function prependRow(det){
      const row=document.createElement("tr");
      row.innerHTML=`
        <td>${new Date(det.detectedAt).toLocaleTimeString()}</td>
        <td>${det.sensorId}</td>
        <td>${det.location}</td>
        <td>${det.rssi}</td>
        <td>${det.freq}</td>
        <td>${(det.confidence*100).toFixed(0)}%</td>`;
      tableBody.prepend(row);
      if(tableBody.rows.length>100) tableBody.deleteRow(-1);
    }

    /* ========= MAP INITIALISATION ========= */
    const map = L.map('radarMap').setView([43.0481,-76.1474], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    function addMarker(det){
      const marker=L.circleMarker([det.lat,det.lon],{radius:8,color:'#28a745',fillColor:'#28a745',fillOpacity:0.7});
      marker.addTo(map).bindPopup(`Detected ${new Date(det.detectedAt).toLocaleTimeString()}<br>RSSI ${det.rssi} dBm`);
      setTimeout(()=>{ if(map.hasLayer(marker)) map.removeLayer(marker); },5*60*1000); // remove after 5 min
    }

    /* ========= INITIALISE DASHBOARD ========= */
    renderSensors();
    setInterval(()=>{
      const det=mockDetection();
      prependRow(det);
      addMarker(det);
      const s=sensors[0];
      s.lastSeen=det.detectedAt;
      s.signalStrength=Math.min(100,Math.max(0,s.signalStrength+Math.round(rand(-3,3))));
      renderSensors();
    },5000);
  </script>
</body>
</html>
